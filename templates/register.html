{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Register with Face & Username</title>
    <link href="{% static 'css/style.css' %}" rel="stylesheet" />
    <meta name="csrf-token" content="{{ csrf_token }}" />
  </head>
  <body
    class="h-screen m-0 p-0 box-border font-[Segoe_UI] flex justify-center items-center animate-gradient bg-[length:400%_400%] bg-[linear-gradient(-45deg,#ee7752,#e73c7e,#23a6d5,#23d5ab)]"
  >
    <!-- About Us Button -->
    <a class="absolute top-6 left-6" href="/about">
      <button
        class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-white hover:text-gray-800 transition-all duration-300 transform hover:scale-105"
      >
        About Us
      </button>
    </a>

    <!-- Register Form Container -->
    <div
      class="bg-white/15 backdrop-blur p-10 rounded-2xl shadow-[0_8px_32px_0_rgba(31,38,135,0.37)] border border-white/20 w-[500px] text-center animate-fadeIn"
    >
      <h2 class="text-white text-2xl font-semibold mb-6">
        Register with Username and Face
      </h2>

      <form id="registerForm" method="POST" class="space-y-4">
        {% csrf_token %}

        <!-- Username Input -->
        <input
          type="text"
          name="username"
          id="username"
          placeholder="Enter Username"
          class="w-full p-3 rounded-xl border-none outline-none text-base"
          required
        />

        <!-- Video Stream -->
        <video
          id="video"
          autoplay
          class="w-full rounded-xl border-2 border-white shadow-[0_0_10px_rgba(255,255,255,0.5)]"
        ></video>

        <!-- Hidden Canvas -->
        <canvas id="canvas" class="hidden"></canvas>

        <!-- Action Buttons -->
        <div class="flex justify-center gap-4">
          <button
            type="button"
            id="capture-button"
            class="px-5 py-2 text-base rounded-xl bg-white text-gray-800 hover:bg-gray-800 hover:text-white transition-all duration-300 transform hover:scale-105"
          >
            Capture Face
          </button>
          <button
            type="submit"
            id="register-button"
            class="px-5 py-2 text-base rounded-xl bg-white text-gray-800 hover:bg-gray-800 hover:text-white transition-all duration-300 transform hover:scale-105"
          >
            Register
          </button>
        </div>
      </form>

      <!-- Feedback Message -->
      <div id="messageDiv" class="mt-4 text-sm text-white min-h-[20px]"></div>

      <!-- Go to Login -->
      <a href="/face_login">
        <button
          type="button"
          class="mt-4 px-5 py-2 text-base rounded-xl bg-transparent border border-white text-white hover:bg-white hover:text-gray-800 transition-all duration-300 transform hover:scale-105"
        >
          Go to Login
        </button>
      </a>
    </div>

    <!-- Script -->
    <script>
      const canvas = document.getElementById("canvas");
      const captureButton = document.getElementById("capture-button");
      const registerForm = document.getElementById("registerForm");
      const messageDiv = document.getElementById("messageDiv");
      const video = document.getElementById("video");

      let capturedImage = null;

      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch(() => {
          messageDiv.innerText = "Camera not accessible.";
        });

      captureButton.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        capturedImage = canvas.toDataURL("image/jpeg");
        messageDiv.innerText = "Face captured successfully!";
      };

      registerForm.onsubmit = async (e) => {
        e.preventDefault();
        if (!capturedImage) {
          messageDiv.innerText = "Please capture a face first.";
          return;
        }

        const formData = new FormData(registerForm);
        formData.append("face_image", capturedImage);

        const response = await fetch("/register/", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        messageDiv.innerText = result.message || "Registration failed";

        if (result.status === "success") {
          setTimeout(() => {
            window.location.href = "/face_login";
          }, 1500);
        }
      };
    </script>

    <!-- Animation Styles -->
    <style>
      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .animate-gradient {
        animation: gradientBG 5s ease infinite;
      }
      @keyframes fadeIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .animate-fadeIn {
        animation: fadeIn 1.2s ease-in-out;
      }
    </style>
  </body>
</html>
