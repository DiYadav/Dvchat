{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token }}" />
  </head>
  <body class="bg-black h-screen flex items-center justify-center font-sans">

    <!-- Container -->
    <div class="flex bg-black text-white rounded-lg shadow-lg max-w-5xl w-full p-4">

      <!-- Left Side Image Mock -->
      <div class="bg-slate-500 hidden lg:block w-1/2 ">
        <img src="{% static 'images/world.png' %}" alt="AppImage" class="w-full top-10" />
      </div>

      <!-- Right Side Form -->
      <div class="w-full lg:w-1/2 flex flex-col justify-center px-6 py-8 space-y-6">

        <h1 class="text-4xl font-bold text-center mb-4">DVCHAT</h1>

        <!-- Username Input -->
        <input
          id="username"
          type="text"
          placeholder="Username"
          class="w-full p-3 rounded bg-gray-800 text-white focus:outline-none"
        />

        <!-- Password Input -->
        <input
          id="password"
          type="password"
          placeholder="Password"
          class="w-full p-3 rounded bg-gray-800 text-white focus:outline-none"
        />

        <!-- Buttons -->
        <button
          onclick="handlePasswordLogin()"
          class="bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition"
        >Login</button>

        <div class="flex items-center justify-center text-sm text-gray-400">OR</div>

        <!-- Face login video -->
        <video id="video" autoplay muted class="w-full h-48 object-cover rounded border-2 border-gray-600"></video>
        <button
          id="capture-button"
          class="bg-white text-black py-2 rounded hover:bg-gray-200 transition"
        >Login with Face</button>

        <div id="loginMessage" class="text-sm text-center text-red-400 min-h-[1rem]"></div>

        <div class="text-sm text-center">
          Donâ€™t have an account? <a href="{% url 'register' %}" class="text-blue-400 hover:underline">Sign up</a>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      const video = document.getElementById("video");
      const captureBtn = document.getElementById("capture-button");
      const canvas = document.createElement("canvas");

      const getCSRFToken = () => document.querySelector('meta[name="csrf-token"]').content;

      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
      });

      captureBtn.onclick = async () => {
        const username = document.getElementById("username").value.trim();
        if (!username) return document.getElementById("loginMessage").innerText = "Enter username first.";

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        const imageData = canvas.toDataURL("image/jpeg");

        const formData = new FormData();
        formData.append("username", username);
        formData.append("face_image", imageData);

        const response = await fetch("{% url 'face_login' %}", {
          method: "POST",
          headers: { "X-CSRFToken": getCSRFToken() },
          body: formData,
        });

        const result = await response.json();
        document.getElementById("loginMessage").innerText = result.message;
        if (result.status === "success") window.location.href = "/";
      };

      async function handlePasswordLogin() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const response = await fetch("{% url 'password_login' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": getCSRFToken(),
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username, password }),
        });
        const result = await response.json();
        document.getElementById("loginMessage").innerText = result.message;
        if (result.status === "success") window.location.href = "/";
      }
    </script>
  </body>
</html>
